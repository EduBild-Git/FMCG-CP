[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Visit Management",
  "enabled": 1,
  "modified": "2025-11-09 12:47:12.239302",
  "module": "FMCG-CP",
  "name": "Customer Visit Management-Form",
  "script": "frappe.ui.form.on('Customer Visit Management', {\n\trefresh(frm) {\n\t\tif (frm.is_new()) {\n          frm.set_value(\"channel_partner\", \"\");\n        }\n\t},\n\tcustomer_level(frm){\n        frm.set_value(\"customer\", \"\")\n        frm.set_value(\"unv_customer\", \"\")\n    },\n    customer(frm) {\n        if (!frm.doc.customer) {\n          frm.set_value(\"channel_partner\", \"\");\n        }\n    },\n    unv_customer(frm) {\n        if (!frm.doc.unv_customer) {\n          frm.set_value(\"channel_partner\", \"\");\n        }\n    },\n})\n\ncur_frm.set_query(\"customer\", function (frm) {\n  var filter_dict = {\n    customer_level: cur_frm.doc.customer_level,\n  }\n  if (cur_frm.doc.channel_partner){\n    filter_dict.custom_channel_partner = cur_frm.doc.channel_partner\n  }\n  return {\n    filters: filter_dict,\n  };\n});\n\ncur_frm.set_query(\"unv_customer\", function (frm) {\n  var filter_dict = {\n    customer_level: cur_frm.doc.customer_level,\n  }\n  if (cur_frm.doc.channel_partner){\n    filter_dict.channel_partner = cur_frm.doc.channel_partner\n  }\n  return {\n    filters: filter_dict,\n  };\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Trial Plan",
  "enabled": 1,
  "modified": "2025-11-09 12:48:01.812422",
  "module": "FMCG-CP",
  "name": "Trial Plan-Form",
  "script": "frappe.ui.form.on('Trial Plan', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\tcustomer_level(frm){\n        frm.set_value(\"customer\", \"\")\n        frm.set_value(\"unv_customer\", \"\")\n    },\n    customer(frm) {\n        if (!frm.doc.customer) {\n          frm.set_value(\"channel_partner\", \"\");\n        }\n    },\n    unv_customer(frm) {\n        if (!frm.doc.unv_customer) {\n          frm.set_value(\"channel_partner\", \"\");\n        }\n    },\n})\n\ncur_frm.set_query(\"customer\", function (frm) {\n  var filter_dict = {\n    customer_level: cur_frm.doc.customer_level,\n  }\n  if (cur_frm.doc.channel_partner){\n    filter_dict.custom_channel_partner = cur_frm.doc.channel_partner\n  }\n  return {\n    filters: filter_dict,\n  };\n});\n\ncur_frm.set_query(\"unv_customer\", function (frm) {\n  var filter_dict = {\n    customer_level: cur_frm.doc.customer_level,\n  }\n  if (cur_frm.doc.channel_partner){\n    filter_dict.channel_partner = cur_frm.doc.channel_partner\n  }\n  return {\n    filters: filter_dict,\n  };\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Journey Plan",
  "enabled": 1,
  "modified": "2025-11-15 17:37:30.493304",
  "module": "FMCG-CP",
  "name": "Journey Plan",
  "script": "// Copyright (c) 2025, Edubild and contributors\n// For license information, please see license.txt\n\nfrappe.ui.form.on('Journey Plan', {\n    setup(frm) {\n        // Warm both caches early\n        preload_secondary_customers();\n    },\n    refresh(frm) {\n        // Ensure caches are ready, then bind focus handlers once\n        Promise.all([preload_secondary_customers()]).then(() => {\n            bind_secondary_focus_handler(frm);\n        });\n    }\n});\n\n// ---- Journey Plan: Primary & Secondary customer multi-select-to-CSV for trips child table ----\n\nlet __SECONDARY_CACHE = [];\nlet __SECONDARY_BIND_DONE = false;\n\n\n// Load once and cache the list of Secondary customers\nfunction preload_secondary_customers() {\n    if (__SECONDARY_CACHE.length) return Promise.resolve(__SECONDARY_CACHE);\n\n    return new Promise((resolve) => {\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Customer',\n                filters: { customer_level: 'Secondary' },\n                fields: ['name'],\n                order_by: 'name asc',\n                limit_page_length: 1000\n            },\n            callback: (r) => {\n                __SECONDARY_CACHE = (r.message || []).map(d => d.name);\n                resolve(__SECONDARY_CACHE);\n            },\n            error: () => resolve([])\n        });\n    });\n}\n\n// Normalize MultiCheck return formats across Frappe versions\nfunction normalize_multicheck(val) {\n    if (Array.isArray(val)) {\n        // Could be array of strings or array of {label,value,checked}\n        return val\n            .map(v => (typeof v === 'string' ? v : (v?.value || v?.label || '')))\n            .filter(Boolean);\n    }\n    if (val && typeof val === 'object') {\n        // Could be object map: { \"Customer A\": 1, \"Customer B\": 0 }\n        return Object.keys(val).filter(k => !!val[k]);\n    }\n    return [];\n}\n\n// Generic picker dialog for a given field + option list\nfunction open_customer_picker_dialog({ frm, cdt, cdn, fieldname, title, options_source }) {\n    const row = locals[cdt][cdn];\n    if (!row) return;\n\n    const choices = options_source();\n    if (!choices.length) {\n        frappe.msgprint(__('No customers found for {0}.', [title]));\n        return;\n    }\n\n    const already = (row[fieldname] || '')\n        .split(',')\n        .map(s => s.trim())\n        .filter(Boolean);\n\n    const options = choices.map(name => ({\n        label: name,\n        value: name,\n        checked: already.includes(name)\n    }));\n\n    const d = new frappe.ui.Dialog({\n        title,\n        size: 'large',\n        fields: [\n            {\n                fieldname: 'customers',\n                fieldtype: 'MultiCheck',\n                label: title,\n                options\n            }\n        ],\n        primary_action_label: __('Apply'),\n        primary_action(values) {\n            const chosen = normalize_multicheck(values.customers);\n            const unique = [...new Set(chosen)].map(s => s.trim()).filter(Boolean);\n            row[fieldname] = unique.join(', ');\n            d.hide();\n            frm.refresh_field('trips');\n        }\n    });\n\n    d.show();\n}\n\n// ---- Secondary Customer: focus binding ----\nfunction bind_secondary_focus_handler(frm) {\n    const grid = frm.fields_dict?.trips?.grid;\n    if (!grid || __SECONDARY_BIND_DONE) return;\n\n    $(grid.wrapper).on(\n        'focus',\n        'input[data-fieldname=\"secondary_customer\"], textarea[data-fieldname=\"secondary_customer\"]',\n        function (e) {\n            const $row = $(this).closest('.grid-row');\n            const cdn = $row.attr('data-name');\n            const cdt = grid.doctype;\n            if (!cdn || !cdt) return;\n\n            e.preventDefault();\n            $(this).blur();\n\n            open_customer_picker_dialog({\n                frm, cdt, cdn,\n                fieldname: 'secondary_customer',\n                title: __('Select Secondary Customers'),\n                options_source: () => __SECONDARY_CACHE\n            });\n        }\n    );\n\n    __SECONDARY_BIND_DONE = true;\n}",
  "view": "Form"
 }
]